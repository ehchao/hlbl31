
################################################################################
#
# Makefile to compile and link C programs with MPI subroutines
#
# Version valid for Linux machines with MPICH
#
# "make" compiles and links the specified main programs and modules,
# using the specified libraries (if any), and produces the executables
#
# "make clean" removes all files generated by "make"
#
# Dependencies on included files are automatically taken care of
#
################################################################################

all: rmxeq  mkxeq
.PHONY: all

OBS_HOME=$(shell pwd)/../../../../
MPI_HOME=/opt/software/mpi/openmpi/1.6.5/gcc447-64
#MPI_HOME=/home/dalibor/openmpi/

# main programs and modules to be compiled

MAIN = hlbl31_write_kernel

FLAGS = flags lat_parms sap_parms dfl_parms solver_parms

LATTICE = bcnds ftidx uidx geometry

LINALG = salg salg_dble liealg cmatrix_dble valg valg_dble cmatrix

RANDOM = ranlux ranlxs ranlxd gauss random_su3

UFLDS = plaq_sum shift uflds udcom

SU3FCTS = chexp su3prod su3ren cm3x3

UTILS = endian mutils utils wspace

SFLDS = sflds scom sdcom Pbnd Pbnd_dble

TCHARGE = ftcom ftensor

SW_TERM = pauli pauli_dble swflds sw_term

DIRAC = Dw_dble Dw Dw_bnd

BLOCK = block blk_grid map_u2blk map_sw2blk map_s2blk

SAP = sap_com dfl_sap_gcr sap blk_solv dfl_modes dfl_subspace ltl_gcr dfl_geometry tmcg sap_gcr

ARCHIVE = archive sarchive

OBSERV = sources stats propagators read_parms alloc_prop observ_utils algebra algebra_legacy
 

LITTLE =  Aw_ops ltl_modes Aw_dble Aw Aw_gen Aw_com

LINSOLV = fgcr fgcr4vd  cgne

VFLDS=  vinit vflds vdcom vcom


QDP = qdp_interface smearing qdp_fourier qdp_source qdp_utils hdf5_output

APPS = calculate_hlbl31 write_3_1_contraction_data read_hlbl31_parms

KERNEL = amu_forlattice getff-new traces 

CHECK = vva4enhung

MODULES = $(FLAGS) $(LATTICE) $(LINALG) $(RANDOM) $(UFLDS) \
          $(SU3FCTS) $(UTILS) $(SFLDS) $(TCHARGE) $(SW_TERM) \
          $(DIRAC) $(BLOCK) $(SAP) $(ARCHIVE) $(OBSERV) \
		  $(LITTLE) $(LINSOLV) $(VFLDS) \
          $(KERNEL) $(CHECK)

QDPMODULES = $(QDP) $(APPS)

# Logging option (-mpilog or -mpitrace or -mpianim)

LOGOPTION =

# search path for modules

MDIR =$(OBS_HOME)/openQCD/openQCD-1.4_patched/modules
ODIR =$(OBS_HOME)/observer/modules/
APPDIR =$(OBS_HOME)/observer/apps/

VPATH = .:$(MDIR)/flags:$(MDIR)/lattice:$(MDIR)/linalg:$(MDIR)/random:\
          $(MDIR)/uflds:$(MDIR)/su3fcts:$(MDIR)/utils:$(MDIR)/sflds:\
          $(MDIR)/tcharge:$(MDIR)/sw_term:$(MDIR)/dirac:$(MDIR)/block:\
		  $(MDIR)/sap:$(MDIR)/archive:$(ODIR)/observ:$(MDIR)/dfl:\
		  $(MDIR)/little:$(MDIR)/linsolv:$(MDIR)/vflds:$(MDIR)/forces/:$(APPDIR)/hlbl31

# additional include directories
qdpinclude=$(OBS_HOME)/qdpxx/include
qdplib=$(OBS_HOME)/qdpxx/lib
qmpinclude=$(OBS_HOME)/qmp/include/
qmplib=$(OBS_HOME)/qmp/lib/


INCPATH = $(MPI_INCLUDE) $(OBS_HOME)/observer/include/ $(MDIR)/../include/ /opt/software/qcd/hdf5-1.18.4-openmpi-1.6.5-gcc482/include $(qdpinclude) $(qmpinclude) /usr/include/libxml2  $(qdpinclude)/../other_libs/qio/include $(qdpinclude)/../other_libs/xpath_reader/include/ $(qdpinclude)/../other_libs/qio/other_libs/c-lime/include/ $(qdpinclude)/../other_libs/libintrin/include/


# additional libraries

LIBS = m hdf5 hdf5_hl qdp qmp qio

LIBPATH = $(MPI_HOME)/lib /opt/software/qcd/hdf5-1.18.4-openmpi-1.6.5-gcc482/lib $(qdplib) $(qmplib)  $(qdplib)/../other_libs/qio/lib


# scheduling and optimization options
VERSIONINFO=$(shell ../../../get_versions.sh)

CFLAGS = -std=c99 -pedantic -fstrict-aliasing \
         -Wall -Wno-long-long -Wstrict-prototypes \
         -g -O2 -Dx64 -DPM -DAVX $(VERSIONINFO)

CXXFLAGS = -std=c++11 -fstrict-aliasing \
           -Wall -Wno-write-strings \
           -g -O2 $(VERSIONINFO)

############################## do not change ###################################

SHELL=/bin/bash
CC=$(MPI_HOME)/bin/mpicc
CXX=$(MPI_HOME)/bin/mpicxx
CLINKER=$(CXX)
GCC=$(CC)
PGMS= $(MAIN) $(MODULES) $(QDPMODULES) 

-include $(addsuffix .d,$(PGMS))


# rule to make dependencies

#$(addsuffix .d,$(PGMS)): %.d: %.cc %.c Makefile
#	@ $(GCC) -ansi $< -MM $(addprefix -I,$(INCPATH)) -o $@


# rule to compile source programs

$(addsuffix .o,$(MODULES)): %.o: %.c Makefile
	$(CC) $< -c $(CFLAGS) $(LOGOPTION) $(addprefix -I,$(INCPATH))

$(addsuffix .o,$(QDPMODULES)): %.o: %.cc Makefile
	$(CXX) $< -c $(CXXFLAGS) $(LOGOPTION) $(addprefix -I,$(INCPATH))

$(addsuffix .o,$(MAIN)): %.o: %.cc Makefile
	$(CXX) $< -c $(CXXFLAGS) $(LOGOPTION) $(addprefix -I,$(INCPATH) )

# rule to link object files

$(MAIN): %: %.o $(addsuffix .o,$(PGMS)) Makefile
	$(CLINKER) $< $(addsuffix .o,$(MODULES)) $(addsuffix .o,$(QDPMODULES)) $(CFLAGS) $(LOGOPTION) \
        $(addprefix -L,$(LIBPATH)) $(addprefix -l,$(LIBS)) -o $@


# produce executables

mkxeq: $(MAIN)


# remove old executables

rmxeq:
	@ -rm -f $(MAIN); \
        echo "delete old executables"


# make dependencies

#mkdep:  $(addsuffix .d,$(PGMS))
#	@ echo "generate tables of dependencies"


# clean directory

clean:
	@ -rm -rf *.d *.o *.alog *.clog *.slog $(MAIN)
.PHONY: clean

################################################################################

